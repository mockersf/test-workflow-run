name: CI - PR Comments

permissions:
  pull-requests: 'write'

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  retrieve-data:
    runs-on: ubuntu-latest
    outputs:
      branch-name: ${{ steps.branch-name.outputs.result }}
    steps:
    - name: 'Download artifact'
      id: find-artifact
      uses: actions/github-script@v7
      with:
        result-encoding: string
        script: |
          var artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: ${{github.event.workflow_run.id }},
          });
          var matchArtifacts = artifacts.data.artifacts.filter((artifact) => {
            return artifact.name == "screenshots-macos"
          });
          if (matchArtifacts.length == 0) { return "false" }
          var matchArtifact = matchArtifacts[0];
          var download = await github.rest.actions.downloadArtifact({
            owner: context.repo.owner,
            repo: context.repo.repo,
            artifact_id: matchArtifact.id,
            archive_format: 'zip',
          });
          var fs = require('fs');
          fs.writeFileSync('${{github.workspace}}/screenshots-macos.zip', Buffer.from(download.data));
          return "true"
    - name: "branch name"
      id: branch-name
      run: |
        unzip screenshots-macos.zip
        if [ -f PR ]; then
          echo "result=PR-$(cat PR)-${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
        else
          echo "result=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
        fi
      
  compare-macos-screenshots:
    name: Compare macOS screenshots
    needs: retrieve-data
    uses: ./.github/workflows/send-screenshots-to-pixeleagle.yml
    with:
      commit: ${{ github.event.workflow_run.head_sha }}
      branch: ${{ needs.retrieve-data.outputs.branch-name }}
      os: macos
    secrets: inherit
